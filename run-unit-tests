#!/bin/bash
set -eux
: ${LOCAL_JENKINS_URL=$JENKINS_URL}
INSTANCE_TYPE=$1
AMI_IMAGE=$2
TRUSTY_PATCH=$3
tarfile=$(python <<EOT
import json
import sys
import urllib2

build_data = urllib2.urlopen(
  '$LOCAL_JENKINS_URL/job/prepare-new-version/lastSuccessfulBuild/api/json')
build_json = json.load(build_data)
for artifact in build_json['artifacts']:
  filename = artifact['fileName']
  if filename.endswith('.tar.gz'):
    break
else:
  sys.exit(1)
print filename
EOT
)
RUN_OUTPUT=$(euca-run-instances -k id_rsa -t $INSTANCE_TYPE $AMI_IMAGE)
if [ $? -ne 0 ]; then
  exit 1
fi

instance_id=$(echo $RUN_OUTPUT|sed -r 's/.*INSTANCE (i-[^ ]*) .*/\1/')
set +x
echo Starting instance $instance_id
instance_ip=''
echo -n Waiting for IP address
while [ -z "$instance_ip" ]; do
  sleep 1
  instance_ip=$(euca-describe-instances $instance_id|sed '/^INSTANCE/!d'|cut -f 17)
  echo -n .
done
echo
echo Instance has ip $instance_ip
sleep 30
echo -n Waiting for SSH
while ! netcat $instance_ip 22 -w 1 -q 0 </dev/null >/dev/null; do
  sleep 1
  echo -n .
done
echo
set -x
set +e
ssh ubuntu@$instance_ip -o "StrictHostKeyChecking no" -o "UserKnownHostsFile /dev/null" <<EOT
set -eux
ssh-keygen -t rsa -b 2048 -N "" -f ~/.ssh/id_rsa
wget -q $JENKINS_URL/job/prepare-new-version/lastSuccessfulBuild/artifact/$tarfile
tar -xzvf $tarfile
export GOPATH=\$HOME/$(echo $tarfile|sed -r 's/(.*).tar.gz/\1/')
cd \$GOPATH/src/launchpad.net/juju-core
# Trusty seems to require an initial update.
sudo apt-get update
sudo apt-get install -y build-essential
if [ "$TRUSTY_PATCH" = "trusty" ]; then
  patch Makefile <<"IEOT"
--- Makefile	2014-01-02 20:01:22.000000000 +0000
+++ Makefile.new	2014-01-02 22:01:30.249833999 +0000
@@ -67,7 +67,7 @@
 # PPA includes the required mongodb-server binaries. However, neither
 # PPA works on Saucy just yet.
 install-dependencies:
-ifneq (\$(shell lsb_release -cs),saucy)
+ifneq (\$(shell lsb_release -cs),trusty)
 	@echo Adding juju PPAs for golang and mongodb-server
 	@sudo apt-add-repository --yes ppa:juju/golang
 	@sudo apt-add-repository --yes ppa:juju/stable
IEOT
fi
make install-dependencies
bzr whoami 'J. Random Hacker <jrandom@example.org>'
make check
EOT
EXIT_STATUS=$?
set -e
euca-terminate-instances $instance_id
exit $EXIT_STATUS
