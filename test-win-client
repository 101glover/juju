#!/bin/bash
set -eux
INSTANCE_ID="i-514c2871"

echo Starting instance $INSTANCE_ID
euca-start-instances $INSTANCE_ID
if [ $? -ne 0 ]; then
    exit 1
fi

set +x
instance_ip=''
echo -n Waiting for IP address
while [ -z "$instance_ip" ]; do
    sleep 1
        instance_ip=$(euca-describe-instances $INSTANCE_ID |
            sed '/^INSTANCE/!d' |
            cut -f 17)
    echo -n .
done
echo
echo Instance has ip $instance_ip
sleep 30

echo -n Waiting for SSH
while ! netcat $instance_ip 22 -w 1 -q 0 </dev/null >/dev/null; do
    sleep 1
    echo -n .
done
echo

set -x
scp -i $JUJU_HOME/staging-juju-rsa \
    -o "StrictHostKeyChecking no" -o "UserKnownHostsFile /dev/null" \
    $SCRIPTS/deploy_stack.py $SCRIPTS/jujupy.py $SCRIPTS/jujuconfig.py \
    Administrator@$instance_ip:/cygdrive/c/Users/Administrator/ci/
if [ $? -ne 0 ]; then
    exit 1
fi
ssh -i $JUJU_HOME/staging-juju-rsa \
    -o "StrictHostKeyChecking no" -o "UserKnownHostsFile /dev/null" \
    Administrator@$instance_ip \
    'juju destroy-environment --force -y test-win-client || juju destroy-environment -e test-win-client'
ssh -i $JUJU_HOME/staging-juju-rsa \
    -o "StrictHostKeyChecking no" -o "UserKnownHostsFile /dev/null" \
    Administrator@$instance_ip \
    '/cygdrive/c/python27/python \\Users\\Administrator\\ci\\deploy_stack.py' \
     test-win-client
EXIT_STATUS=$?
ssh -i $JUJU_HOME/staging-juju-rsa \
    -o "StrictHostKeyChecking no" -o "UserKnownHostsFile /dev/null" \
    Administrator@$instance_ip \
    'juju destroy-environment --force -y test-win-client || juju destroy-environment -e test-win-client'
set -e
set +x
euca-stop-instances $INSTANCE_ID
exit $EXIT_STATUS
