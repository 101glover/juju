#!/bin/bash
set -eux


usage() {
    echo "usage: $0 ADDRESS"
    echo "  ADDRESS: The IP or DNS address the windows test machine."
    echo "  --juju-home: The location of cloud-city and staging-juju-rsa."
    exit 1
}


while [[ "${1-}" != "" && $1 =~ ^-.*  ]]; do
    case $1 in
        --juju-home)
            shift
            JUJU_HOME=$(cd $1; pwd)
            ;;
        --help)
            usage
            ;;
    esac
    shift
done


test $# -eq 1 || usage

HOST="$1"
: ${SCRIPTS=$(readlink -f $(dirname $0))}
export PATH="$SCRIPTS:$PATH"

set -x
scp -i $JUJU_HOME/staging-juju-rsa \
    -o "StrictHostKeyChecking no" -o "UserKnownHostsFile /dev/null" \
    $SCRIPTS/deploy_stack.py $SCRIPTS/jujupy.py $SCRIPTS/jujuconfig.py \
    $SCRIPTS/substrate.py $SCRIPTS/utility.py \
    Administrator@$HOST:/cygdrive/c/Users/Administrator/ci/
if [ $? -ne 0 ]; then
    exit 1
fi
set +e
ssh -i $JUJU_HOME/staging-juju-rsa \
    -o "StrictHostKeyChecking no" -o "UserKnownHostsFile /dev/null" \
    Administrator@$HOST \
    'juju destroy-environment --force -y test-win-client'
ssh -i $JUJU_HOME/staging-juju-rsa \
    -o "StrictHostKeyChecking no" -o "UserKnownHostsFile /dev/null" \
    Administrator@$HOST \
    '/cygdrive/c/python27/python \\Users\\Administrator\\ci\\deploy_stack.py' \
     test-win-client
EXIT_STATUS=$?
ssh -i $JUJU_HOME/staging-juju-rsa \
    -o "StrictHostKeyChecking no" -o "UserKnownHostsFile /dev/null" \
    Administrator@$HOST \
    'juju destroy-environment --force -y test-win-client'
set -e
set +x
exit $EXIT_STATUS
